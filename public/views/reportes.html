<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Reportes - Rendex POS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      body {
        font-family: Inter, ui-sans-serif, system-ui, -apple-system, 'Segoe UI', Roboto,
          'Helvetica Neue', Arial;
      }
    </style>
  </head>
  <body class="bg-gray-50 min-h-screen p-6">
    <div class="max-w-5xl mx-auto">
      <header class="mb-6">
        <h1 class="text-3xl font-semibold text-gray-800">Reportes de Ventas</h1>
        <p class="text-sm text-gray-500 mt-1">Resumen por rango de fechas (USD / VES)</p>
      </header>

      <section class="bg-white shadow rounded-lg p-6 mb-6">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
          <div>
            <label class="text-sm text-gray-600">Fecha inicio</label>
            <input
              id="startDate"
              type="date"
              class="mt-1 block w-full border-gray-200 rounded-md p-2"
            />
          </div>
          <div>
            <label class="text-sm text-gray-600">Fecha fin</label>
            <input
              id="endDate"
              type="date"
              class="mt-1 block w-full border-gray-200 rounded-md p-2"
            />
          </div>
          <div class="flex gap-2">
            <button
              id="generate"
              class="bg-indigo-600 text-white px-4 py-2 rounded-md shadow hover:bg-indigo-700"
            >
              Generar Reporte
            </button>
            <button
              id="exportCsv"
              class="bg-green-600 text-white px-4 py-2 rounded-md shadow hover:bg-green-700"
            >
              Exportar CSV
            </button>
            <button
              id="reset"
              class="bg-white border border-gray-200 px-4 py-2 rounded-md hover:bg-gray-50"
            >
              Limpiar
            </button>
          </div>
        </div>
        <div id="status" class="mt-4 text-sm text-gray-500"></div>
      </section>

      <section id="results" class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div class="bg-white rounded-lg shadow p-6">
          <div class="text-sm text-gray-500">Total USD</div>
          <div id="total-usd" class="text-2xl font-bold text-gray-800">-</div>
        </div>
        <div class="bg-white rounded-lg shadow p-6">
          <div class="text-sm text-gray-500">Total VES</div>
          <div id="total-ves" class="text-2xl font-bold text-gray-800">-</div>
        </div>
        <div class="bg-white rounded-lg shadow p-6">
          <div class="text-sm text-gray-500">Transacciones</div>
          <div id="count" class="text-2xl font-bold text-gray-800">-</div>
        </div>
      </section>

      <footer class="mt-8 text-sm text-gray-500">
        Tip: usa el token de sesión en `localStorage.token` (debes estar autenticado).
      </footer>
    </div>

    <script>
      function authHeaders() {
        const t = localStorage.getItem('token');
        return t ? { Authorization: 'Bearer ' + t } : {};
      }

      let lastResponse = null;
      let lastParams = null;

      document.getElementById('generate').addEventListener('click', async () => {
        const s = document.getElementById('startDate').value;
        const e = document.getElementById('endDate').value;
        const status = document.getElementById('status');
        if (!s || !e) {
          status.textContent = 'Seleccione ambas fechas.';
          return;
        }
        status.textContent = 'Generando reporte...';
        try {
          const qs = new URLSearchParams({ startDate: s, endDate: e }).toString();
          const resp = await fetch('/api/reports/sales-summary?' + qs, {
            headers: Object.assign({ 'Content-Type': 'application/json' }, authHeaders()),
          });
          if (resp.status === 401 || resp.status === 403) {
            status.textContent =
              'No autorizado. Inicie sesión con una cuenta con permisos de gerente/analista.';
            return;
          }
          const j = await resp.json();
          if (!resp.ok) {
            status.textContent = j.error || 'Error al generar reporte';
            return;
          }
          lastResponse = j;
          lastParams = { startDate: s, endDate: e };
          document.getElementById('total-usd').textContent = j.total_sales_usd + ' USD';
          document.getElementById('total-ves').textContent = j.total_sales_ves + ' VES';
          document.getElementById('count').textContent = j.count_of_transactions;
          status.textContent = 'Reporte generado.';
        } catch (err) {
          status.textContent = 'Error de red: ' + err.message;
        }
      });

      document.getElementById('exportCsv').addEventListener('click', () => {
        const status = document.getElementById('status');
        if (!lastResponse || !lastParams) {
          status.textContent = 'Genere un reporte antes de exportar.';
          return;
        }
        try {
          const rows = [];
          rows.push([
            'Reporte de Ventas',
            'Desde',
            lastParams.startDate,
            'Hasta',
            lastParams.endDate,
          ]);
          rows.push(['Total USD', lastResponse.total_sales_usd]);
          rows.push(['Total VES', lastResponse.total_sales_ves]);
          rows.push(['Transacciones', lastResponse.count_of_transactions]);
          rows.push([]);
          if (Array.isArray(lastResponse.transactions) && lastResponse.transactions.length) {
            const tx = lastResponse.transactions;
            const headers = Object.keys(tx[0]);
            rows.push(headers);
            for (const t of tx) {
              rows.push(
                headers.map((h) => (t[h] !== undefined && t[h] !== null ? String(t[h]) : ''))
              );
            }
          }

          const csv = rows
            .map((r) =>
              r
                .map((cell) => {
                  if (
                    typeof cell === 'string' &&
                    (cell.includes(',') || cell.includes('"') || cell.includes('\n'))
                  ) {
                    return '"' + cell.replace(/"/g, '""') + '"';
                  }
                  return cell;
                })
                .join(',')
            )
            .join('\n');

          const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
          const fname = `reportes-${lastParams.startDate}_${lastParams.endDate}.csv`;
          const link = document.createElement('a');
          const url = window.URL.createObjectURL(blob);
          link.setAttribute('href', url);
          link.setAttribute('download', fname);
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
          window.URL.revokeObjectURL(url);
          status.textContent = 'CSV descargado.';
        } catch (err) {
          status.textContent = 'Error generando CSV: ' + err.message;
        }
      });

      document.getElementById('reset').addEventListener('click', () => {
        document.getElementById('startDate').value = '';
        document.getElementById('endDate').value = '';
        document.getElementById('total-usd').textContent = '-';
        document.getElementById('total-ves').textContent = '-';
        document.getElementById('count').textContent = '-';
        document.getElementById('status').textContent = '';
        lastResponse = null;
        lastParams = null;
      });
    </script>
  </body>
</html>
